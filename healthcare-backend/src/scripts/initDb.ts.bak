import pool from '../config/database';
import dotenv from 'dotenv';

dotenv.config();

/**
 * Initialize healthcare appointment database
 * Creates all tables, indexes, and constraints
 */
async function initializeDatabase() {
  const client = await pool.connect();

  try {
    console.log('üóÑÔ∏è  Initializing healthcare appointment database...\n');

    // Create ENUM types
    console.log('üìù Creating ENUM types...');
    await client.query(`
      DO $$
      BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'appointment_status') THEN
          CREATE TYPE appointment_status AS ENUM ('PENDING', 'CONFIRMED', 'COMPLETED', 'CANCELLED', 'NO_SHOW');
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'slot_status') THEN
          CREATE TYPE slot_status AS ENUM ('AVAILABLE', 'BOOKED', 'FULL');
        END IF;
        IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'consultation_type') THEN
          CREATE TYPE consultation_type AS ENUM ('IN_PERSON', 'TELEMEDICINE', 'HYBRID');
        END IF;
      END $$;
    `);

    // Create doctors table
    console.log('üë®‚Äç‚öïÔ∏è  Creating doctors table...');
    await client.query(`
      CREATE TABLE IF NOT EXISTS doctors (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        name VARCHAR(255) NOT NULL,
        specialization VARCHAR(100) NOT NULL,
        email VARCHAR(255) UNIQUE NOT NULL,
        phone VARCHAR(20) NOT NULL,
        license_number VARCHAR(50) UNIQUE NOT NULL,
        clinic_name VARCHAR(255),
        address TEXT,
        bio TEXT,
        is_active BOOLEAN DEFAULT true,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      );
    `);

    // Create patients table
    console.log('üë§ Creating patients table...');
    await client.query(`
      CREATE TABLE IF NOT EXISTS patients (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        name VARCHAR(255) NOT NULL,
        email VARCHAR(255) UNIQUE NOT NULL,
        phone VARCHAR(20) NOT NULL,
        date_of_birth DATE,
        gender VARCHAR(20),
        blood_group VARCHAR(5),
        medical_history TEXT,
        allergies TEXT,
        emergency_contact_name VARCHAR(255),
        emergency_contact_phone VARCHAR(20),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      );
    `);

    // Create time_slots table
    console.log('‚è∞ Creating time_slots table...');
    await client.query(`
      CREATE TABLE IF NOT EXISTS time_slots (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        doctor_id UUID NOT NULL REFERENCES doctors(id) ON DELETE CASCADE,
        slot_date DATE NOT NULL,
        slot_time TIME NOT NULL,
        duration_minutes INTEGER NOT NULL DEFAULT 30,
        max_capacity INTEGER NOT NULL DEFAULT 1,
        current_bookings INTEGER NOT NULL DEFAULT 0,
        status slot_status DEFAULT 'AVAILABLE',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        UNIQUE(doctor_id, slot_date, slot_time)
      );
    `);

    // Create appointments table
    console.log('üìÖ Creating appointments table...');
    await client.query(`
      CREATE TABLE IF NOT EXISTS appointments (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        patient_id UUID NOT NULL REFERENCES patients(id) ON DELETE CASCADE,
        doctor_id UUID NOT NULL REFERENCES doctors(id) ON DELETE CASCADE,
        time_slot_id UUID NOT NULL REFERENCES time_slots(id) ON DELETE CASCADE,
        appointment_date DATE NOT NULL,
        appointment_time TIME NOT NULL,
        reason_for_visit TEXT NOT NULL,
        consultation_type consultation_type NOT NULL DEFAULT 'IN_PERSON',
        status appointment_status DEFAULT 'PENDING',
        notes TEXT,
        expires_at TIMESTAMP,
        confirmed_at TIMESTAMP,
        completed_at TIMESTAMP,
        cancelled_at TIMESTAMP,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      );
    `);

    // Create audit_logs table
    console.log('üìã Creating audit_logs table...');
    await client.query(`
      CREATE TABLE IF NOT EXISTS audit_logs (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        entity_type VARCHAR(100) NOT NULL,
        entity_id UUID NOT NULL,
        action VARCHAR(50) NOT NULL,
        old_values JSONB,
        new_values JSONB,
        user_id UUID,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      );
    `);

    // Create indexes for performance
    console.log('üîç Creating indexes...');
    await client.query(`
      CREATE INDEX IF NOT EXISTS idx_doctors_email ON doctors(email);
      CREATE INDEX IF NOT EXISTS idx_doctors_specialization ON doctors(specialization);
      CREATE INDEX IF NOT EXISTS idx_doctors_is_active ON doctors(is_active);
      
      CREATE INDEX IF NOT EXISTS idx_patients_email ON patients(email);
      
      CREATE INDEX IF NOT EXISTS idx_time_slots_doctor_id ON time_slots(doctor_id);
      CREATE INDEX IF NOT EXISTS idx_time_slots_slot_date ON time_slots(slot_date);
      CREATE INDEX IF NOT EXISTS idx_time_slots_status ON time_slots(status);
      
      CREATE INDEX IF NOT EXISTS idx_appointments_patient_id ON appointments(patient_id);
      CREATE INDEX IF NOT EXISTS idx_appointments_doctor_id ON appointments(doctor_id);
      CREATE INDEX IF NOT EXISTS idx_appointments_time_slot_id ON appointments(time_slot_id);
      CREATE INDEX IF NOT EXISTS idx_appointments_status ON appointments(status);
      CREATE INDEX IF NOT EXISTS idx_appointments_expires_at ON appointments(expires_at);
      CREATE INDEX IF NOT EXISTS idx_appointments_appointment_date ON appointments(appointment_date);
      
      CREATE INDEX IF NOT EXISTS idx_audit_logs_entity_id ON audit_logs(entity_id);
      CREATE INDEX IF NOT EXISTS idx_audit_logs_created_at ON audit_logs(created_at);
    `);

    console.log('\n‚úÖ Database initialization completed successfully!\n');

    // Insert sample data
    console.log('üìå Inserting sample data...\n');

    // Sample doctors
    const doctors = [
      {
        name: 'Dr. Rajesh Kumar',
        specialization: 'Cardiology',
        email: 'rajesh.kumar@clinic.com',
        phone: '+91-9876543210',
        license_number: 'MED-2020-001',
        clinic_name: 'Heart Health Clinic',
        address: '123 Medical Street, Delhi',
        bio: 'Experienced cardiologist with 15 years of practice',
      },
      {
        name: 'Dr. Priya Sharma',
        specialization: 'Dermatology',
        email: 'priya.sharma@clinic.com',
        phone: '+91-9876543211',
        license_number: 'MED-2021-002',
        clinic_name: 'Skin Care Center',
        address: '456 Wellness Lane, Mumbai',
        bio: 'Specialist in skin conditions and cosmetic dermatology',
      },
      {
        name: 'Dr. Amit Patel',
        specialization: 'General Medicine',
        email: 'amit.patel@clinic.com',
        phone: '+91-9876543212',
        license_number: 'MED-2019-003',
        clinic_name: 'General Care Clinic',
        address: '789 Health Avenue, Bangalore',
        bio: 'General physician with expertise in preventive healthcare',
      },
    ];

    const doctorInsertQuery = `
      INSERT INTO doctors (name, specialization, email, phone, license_number, clinic_name, address, bio)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
      RETURNING id;
    `;

    const insertedDoctors = [];
    for (const doctor of doctors) {
      try {
        const result = await client.query(doctorInsertQuery, [
          doctor.name,
          doctor.specialization,
          doctor.email,
          doctor.phone,
          doctor.license_number,
          doctor.clinic_name,
          doctor.address,
          doctor.bio,
        ]);
        if (result.rows[0]) {
          insertedDoctors.push(result.rows[0].id);
          console.log(`‚úì Added doctor: ${doctor.name}`);
        }
      } catch (err: any) {
        if (err.code === '23505') {
          console.log(`‚úì Doctor already exists: ${doctor.name}`);
        } else {
          console.log(`! Error adding doctor ${doctor.name}: ${err.message}`);
        }
      }
    }

    // Sample patients
    const patients = [
      {
        name: 'Rahul Verma',
        email: 'rahul.verma@email.com',
        phone: '+91-9988776655',
        date_of_birth: '1990-05-15',
        gender: 'Male',
        blood_group: 'O+',
      },
      {
        name: 'Anjali Singh',
        email: 'anjali.singh@email.com',
        phone: '+91-9988776656',
        date_of_birth: '1995-03-20',
        gender: 'Female',
        blood_group: 'B+',
      },
      {
        name: 'Vishal Desai',
        email: 'vishal.desai@email.com',
        phone: '+91-9988776657',
        date_of_birth: '1988-12-10',
        gender: 'Male',
        blood_group: 'A+',
      },
    ];

    const patientInsertQuery = `
      INSERT INTO patients (name, email, phone, date_of_birth, gender, blood_group)
      VALUES ($1, $2, $3, $4, $5, $6)
      RETURNING id;
    `;

    const insertedPatients = [];
    for (const patient of patients) {
      try {
        const result = await client.query(patientInsertQuery, [
          patient.name,
          patient.email,
          patient.phone,
          patient.date_of_birth,
          patient.gender,
          patient.blood_group,
        ]);
        if (result.rows[0]) {
          insertedPatients.push(result.rows[0].id);
          console.log(`‚úì Added patient: ${patient.name}`);
        }
      } catch (err: any) {
        if (err.code === '23505') {
          console.log(`‚úì Patient already exists: ${patient.name}`);
        } else {
          console.log(`! Error adding patient ${patient.name}: ${err.message}`);
        }
      }
    }

    // Sample time slots (next 7 days)
    if (insertedDoctors.length > 0) {
      console.log('\n‚è∞ Adding sample time slots...');
      const timeSlots = [
        { time: '09:00:00', capacity: 2 },
        { time: '10:00:00', capacity: 2 },
        { time: '14:00:00', capacity: 1 },
        { time: '15:30:00', capacity: 2 },
      ];

      for (let dayOffset = 1; dayOffset <= 5; dayOffset++) {
        const date = new Date();
        date.setDate(date.getDate() + dayOffset);
        const dateStr = date.toISOString().split('T')[0];

        for (const slot of timeSlots) {
          const slotQuery = `
            INSERT INTO time_slots (doctor_id, slot_date, slot_time, max_capacity)
            VALUES ($1, $2, $3, $4);
          `;

          try {
            await client.query(slotQuery, [insertedDoctors[0], dateStr, slot.time, slot.capacity]);
          } catch (err: any) {
            // Slot might already exist, that's ok
          }
        }
      }
      console.log(`‚úì Added time slots for next 5 days`);
    }

    console.log('\n‚ú® Database ready with sample data!\n');
    console.log('üöÄ You can now start the server with: npm run dev\n');

    process.exit(0);
  } catch (error) {
    console.error('‚ùå Database initialization failed:', error);
    process.exit(1);
  } finally {
    client.release();
  }
}

// Run initialization
initializeDatabase();
